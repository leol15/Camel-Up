<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>GAME</title>
	<style type="text/css">

		/* variables */
		:root {
			--bg: #333;
			--fg: #eee;
		}

		html, body {
			padding: 0;
			margin: 0;
			background-color: var(--bg);
			color: var(--fg);
		}
		* {
			box-sizing: border-box;
			font-family: monospace;
		}
		a {
			color: var(--fg);
		}

		/*debug*/
		*:hover {
			/*outline: 1px solid red;*/
		}

		/*link banner*/
		#banner {
			font-size: 2em;
			background-color: black;
			color: var(--fg);
			text-align: center;
			padding: 15px;
			transition: all 0.5s;
		}
		#banner:hover {
			cursor: pointer;
		}
		#banner:active {
			transition: all 0.2s;
			background-color: var(--fg);
		}

		/*pick name*/
		#name-area {
			padding: 10px;
			text-align: center;
		}
		#name-input {
			text-align: center;
			transition: all 1s;
		}
		#name-input:focus {
			box-shadow: 0 0 60px var(--fg);
			filter: hue-rotate(360deg);
		}

		/* players */
		#players-area {
			/*text-align: center;*/
			display: flex;
			justify-content: center;
			padding: 10px;
		}
		.player {
			margin: 0 10px;
			padding: 10px 20px;
			display: inline-block;
			background-color: #222;
			border: 2px solid var(--fg);
			position: relative;
			font-size: 1.5em;
			transition: all 0.5s;
		}
		.player .name {
			margin-right: 20px;
		}

		.player:hover .info, .info:hover, .player:hover {
			visibility: visible;
			transition-delay: 0s;
			z-index: 3;
			border-color: orange;
		}
		.player .info {
			border-radius: 10px;
			position: absolute;
			left: 50%;
			bottom: 0;
			transform: translate(-50%, 100%);
			visibility: hidden;
			text-align: left;
			margin: 0;
			padding: 20px 40px;
			box-shadow: 0 0 2px 2px var(--fg);
			background-color: #222;
		}

		/* dice */
		.die-el {
			transition: all 0.7s;
			display: inline-block;
			width: 40px;
			height: 40px;
			border-radius: 4px;
			border: 2px solid var(--fg);
		}

		/* camels */
		#camels-area {
			overflow: hidden;
			height: 30vh;
			background-color: #999;
			position: relative;
		}
		.camel-el {
			position: absolute;
			display: inline-block;
			width: 5%;
			height: calc(100% / 7);
			transition: all 1s;
			transition-delay: 0.4s;
			transition-timing-function: cubic-bezier(.84,-0.33,.38,1.06);
		}

		/* tiles & traps */
		#trap-area {

		}
		.trap-el {
			display: inline-block;
			height: 40px;
			width: calc(100% / 20);
			border: 1px dashed var(--fg);
			transition: all 0.5s;
		}
		.trap-el:hover {
			border-color: #2e2;
			border-style: solid;
			cursor: pointer;
		}
		.trap1 {
			background-color: #2e2;
		}
		.trap-1 {
			background-color: #e22;
		}

		/* bets */
		#bet-area {
			padding: 10px 10px;
			margin: 10px;
			display: inline-block;
			/*border: 1px solid var(--fg);*/
		}
		.bet-el {
			user-select: none;
			color: var(--fg);
			text-shadow: 2px 2px 4px #000;
			font-size: 3em;
			padding: 20px;
			display: inline-block;
			transition: all 0.2s;
			border: 2px solid var(--fg);
			border-radius: 4px;
		}
		.bet-el.active:hover {
			cursor: pointer;
			transform: translate(-2px, -2px);
			box-shadow: 2px 2px var(--fg);
		}
		.active {
			filter: brightness(0.9);
		}
		.inactive {
			filter: brightness(0.3);
		}


	</style>
</head>
<body>
	<!-- display game link -->
	<div id="banner" onclick="copyLinkAddress()"></div>
	<h1>Wellcome! <a href="/">Home</a> <button onclick="resetGame()">Reset</button></h1>
	<!-- pick name -->
	<div id="name-area">
		<span>Name: </span><input onkeyup="createPlayer(this.value)" id="name-input" type="text" placeholder="pick a name" autofocus>
	</div>

	<!-- show players -->
	<div id="players-area">
		<button onclick="getPlayers().then(p => {updatePlayers(p)})">Update Players</button>
	</div>

	<!-- show game -->
	<div id="dice-area">
		<button onclick="makeRoll()">Roll</button>
		<span>Dice Left</span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
	</div>

	<!-- camels -->
	<div id="camels-area">
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
	</div>

	<!-- traps -->
	<div id="trap-area">
	</div>

	<!-- bets -->
	<div id="bet-area">
		<div>
			<b>Click a color to make bet: </b>
			<span class="bet-el active" onclick="placeBet(this)"></span>
			<span class="bet-el active" onclick="placeBet(this)"></span>
			<span class="bet-el active" onclick="placeBet(this)"></span>
			<span class="bet-el active" onclick="placeBet(this)"></span>
			<span class="bet-el active" onclick="placeBet(this)"></span>
		</div>
	</div>

	<script type="text/javascript">
		// fill banner with link address
		let banner_el = document.getElementById('banner')
		// get link name
		let GAME_ID = window.location.pathname.split("/")[2]
		banner_el.innerHTML = "Game link: " + GAME_ID + " (Click to copy)";
		function copyLinkAddress() {
			let dummy_link_el = document.createElement("input");
			dummy_link_el.value = window.location;
			document.body.appendChild(dummy_link_el);
			dummy_link_el.select();
			dummy_link_el.setSelectionRange(0, 99999); /*For mobile devices*/
			document.execCommand("copy");
			dummy_link_el.remove();
		}

		// static final variables
		// url
		let BASE_COMM_URL = window.location.origin + "/gamespeaks/" + GAME_ID
		let user_name = ""
		// helpers
		// return a promise, use then
		// will try to consume a json or text
		function fetch_url(url) {
			// console.log("fetching [" + url + "]")
			return fetch(url)
				.then(res => {
					let type = res.headers.get('content-type')
					if (type.includes("application/json")) {
						return res.json()
					} else if (type.includes("text")) {
						return res.text()
					} else {
						return res.data()
					}
				})
				.then(thing => {
					console.log("Response:")
					console.log(thing);
					return thing
				})
				.catch(err => console.log(err));
		}

		// request using a game action		
		function gameAction(action) {
			return fetch_url(BASE_COMM_URL + "?action=" + encodeURI(action));
		}

		// set uname send address
		function createPlayer(name) {
			if (event.key === "Enter" || event.keyCode === 12) {
				gameAction("uname&uname=" + name)
					.then(name => {
						console.log("new name is " + name)
						user_name = name;
						////// start of game!
						initGame();
					})
			}
		}

		// getters: routes with server defined keys
		function getPlayers() {
			return gameAction("players")
		}

		function getCamels() {
			return gameAction("camels")
		}

		function getDice() {
			return gameAction("dice")
		}

		function getBet() {
			return gameAction("bet")
		}

		function getTrap() {
			return gameAction("trap")
		}

		// actions
		function makeRoll() {
			gameAction("roll").then(li => {
				// update dice
				updateDice(li)
				// then get camels
				getCamels().then(cams => updateCamels(cams))
			})
		}

		// place a bet
		var BET_EMPTY = "0"
		function placeBet(el) {
			if (el.innerText === BET_EMPTY)
				return
			gameAction("makeBet&color=" + el.style.backgroundColor)
				.then(bets => {
					updateBets(bets)
					getPlayers().then(p => updatePlayers(p))
				})
		}

		// place a trap
		function placeTrap(tile, boost="boost") {
			console.log("placing trap " + tile)
			gameAction("placeTrap&tile=" + tile + "&scalar=" + boost)
				.then(traps => updateTraps(traps))
		}

		function resetGame() {
			gameAction("reset").then(t => initGame())
		}

		COLOR_KEYS = ["RED", "GREEN", "BLUE", "PURPLE", "GOLD", "BLACK", "WHITE"]
		// game states
		const dice_el = document.querySelectorAll(".die-el")
		var camels_el = document.querySelectorAll('.camel-el')
		// initialize
		for (var i = 0; i < COLOR_KEYS.length; i++) {
			dice_el[i].style.backgroundColor = COLOR_KEYS[i];
		}
		for (var i = 0; i < COLOR_KEYS.length; i++) {
			camels_el[i].style.backgroundColor = COLOR_KEYS[i];
		}

		// helpers ------------------------

		var updateDice = (availables) => {
			// update
			for (var i = 0; i < COLOR_KEYS.length; i++) {
				if (availables.includes(COLOR_KEYS[i])) {
					dice_el[i].className = "die-el active"
				} else {
					dice_el[i].className = "die-el inactive"
				}
			}
		} 

		// color maps to location
		var updateCamels = (cam) => {
			for (var i = 0; i < COLOR_KEYS.length; i++) {
				var left = cam[COLOR_KEYS[i]][0] / 20 * 100
				camels_el[i].style.left = left + "%"
				var bottom = cam[COLOR_KEYS[i]][1] / 7 * 100
				camels_el[i].style.bottom = bottom + "%"
			}
		}

		let player_list = []
		let player_area_el = document.getElementById('players-area')
		// install or update players
		var updatePlayers = (players) => {
			// remove existing players
			for (var el of document.querySelectorAll(".player")) {
				el.remove()
			}
			for (var player of Object.entries(players)) {
				// console.log(player[0])
				// console.log(player[1])
				showPlayer(player[1])
			}
		}

		// show bets
		var bets_list = document.querySelectorAll(".bet-el")
		for (var i = 0; i < bets_list.length; i++) {
			bets_list[i].style.backgroundColor = COLOR_KEYS[i]	
			bets_list[i].innerText = BET_EMPTY
		}
		var updateBets = (bets) => {
			// bets could have less than 5 things {color, value}
			var availableColors = []
			for (var bet of bets) {
				availableColors.push(bet.color)
			}
			for (var i = 0; i < bets_list.length; i++) {
				if (availableColors.includes(COLOR_KEYS[i])) {
					bets_list[i].className = "bet-el active"
					bets_list[i].innerText = 
						bets[availableColors.indexOf(COLOR_KEYS[i])].value
				} else {
					bets_list[i].innerText = BET_EMPTY
					bets_list[i].className = "bet-el inactive"
				}
			}
		}

		var trap_area_el = document.getElementById('trap-area')
		for (var i = 0; i < 20; i++) {
			var trap_el = document.createElement("span")
			trap_el.className = "trap-el";
			// strange var capture here
			(() => {
				var tile = i
				trap_el.onclick = () => placeTrap(tile)
			})();
			trap_area_el.appendChild(trap_el)
		}
		// show traps {value, player, tile}
		var updateTraps = (traps) => {
			var traps_el = document.querySelectorAll(".trap-el")
			traps_el.forEach(el => el.className = "trap-el")
			traps.forEach(t => {
				console.log(traps_el.length)
				traps_el[t.tile].className = "trap-el trap" + t.value
			})
		}

		// name, coin
		function showPlayer(player) {
			// creat elements
			var player_el = document.createElement("div")
			player_el.className = "player"
			// name & coin
			var name_el = document.createElement("span")
			name_el.className = "name"
			var coin_el = document.createElement("span")
			coin_el.className = "coin"
			// info
			var info_el = document.createElement("ul")
			info_el.className = "info"
			// name, coins, bets, betTags, globalBets, trap
			name_el.innerText = player.name
			coin_el.innerText = player.coin

			// add to info list
			var bets_el = document.createElement("li")
			bets_el.innerText = "bets: " + JSON.stringify(player.bets)
			info_el.appendChild(bets_el)
			var global_bets_el = document.createElement("li")
			global_bets_el.innerText = "global bets: " + JSON.stringify(player.globalBets)
			info_el.appendChild(global_bets_el)
			var trap_info_el = document.createElement("li")
			trap_info_el.innerText = "traps: " + JSON.stringify(player.trap)
			info_el.appendChild(trap_info_el)

			// add to body
			player_el.appendChild(name_el)
			player_el.appendChild(coin_el)
			player_el.appendChild(info_el)
			player_area_el.appendChild(player_el)
		}



		// start of game
		function initGame() {
			// body...
			// fetch everything
			// dice
			getDice().then(li => updateDice(li));
			// camels
			getCamels().then(cam => updateCamels(cam));
			// players
			getPlayers().then(p => updatePlayers(p))
			// show bets
			getBet().then(b => updateBets(b))
			// show traps

			getTrap().then(t => updateTraps(t))
		}

		// auto start/login
		let name_input_el = document.getElementById('name-input')
		if (name_input_el.value !== "") {
			initGame()
		}
		

	</script>
</body>
</html>

