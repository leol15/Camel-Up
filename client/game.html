<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>GAME</title>
	<style type="text/css">
		html, body {
			padding: 0;
			margin: 0;
			background-color: #444;
			color: #eee;
		}
		* {
			box-sizing: border-box;
			font-family: monospace;
		}

		/*debug*/
		*:hover {
			outline: 1px solid red;
		}

		/*link banner*/
		#banner {
			font-size: 2em;
			background-color: black;
			color: white;
			text-align: center;
			padding: 15px;
			transition: all 0.5s;
		}
		#banner:hover {
			cursor: pointer;
		}
		#banner:active {
			transition: all 0.2s;
			background-color: white;
		}

		/*pick name*/
		#name-area {
			padding: 10px;
			text-align: center;
		}
		#name-input {
			text-align: center;
		}

		/* dice */
		.die-el {
			opacity: 1;
			transition: all 0.7s;
			display: inline-block;
			width: 40px;
			height: 40px;
			border-radius: 4px;
			border: 2px solid white;
		}

		/* camels */
		#camels-area {
			height: 300px;
			background-color: #999;
			position: relative;
		}
		.camel-el {
			position: absolute;
			left: 0%;
			bottom: 0%;
			display: inline-block;
			width: 5%;
			height: calc(100% / 7);
			transition: all 1s;
			transition-delay: 0.4s;
			transition-timing-function: cubic-bezier(.84,-0.33,.38,1.06);
		}
	</style>
</head>
<body>
	<!-- display game link -->
	<div id="banner" onclick="copyLinkAddress()"></div>
	<h1>Wellcome! <a href="/">home</a></h1>
	<!-- pick name -->
	<div id="name-area">
		<span>Name: </span><input onkeyup="createPlayer(this.value)" id="name-input" type="text" placeholder="pick a name" autofocus>
	</div>

	<!-- show game -->
	<div id="dice-area">
		<button onclick="makeRoll()">Roll</button>
		<span>Dice Left</span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
		<span class="die-el"></span>
	</div>

	<!-- camels -->
	<div id="camels-area">
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
		<span class="camel-el"></span>
	</div>

	<script type="text/javascript">
		// fill banner with link address
		let banner_el = document.getElementById('banner')
		// get link name
		let GAME_ID = window.location.pathname.split("/")[2]
		banner_el.innerHTML = "Game link: " + GAME_ID + " (Click to copy)";
		function copyLinkAddress() {
			let dummy_link_el = document.createElement("input");
			dummy_link_el.value = window.location;
			document.body.appendChild(dummy_link_el);
			dummy_link_el.select();
			dummy_link_el.setSelectionRange(0, 99999); /*For mobile devices*/
			document.execCommand("copy");
			dummy_link_el.remove();
		}

		// static final variables
		let GAME_COMM_ROUTE = "gamespeaks/"
		let NAME_KEY = "uname"
		// getters
		let DICE_KEY = "dice"
		let BET_KEY = "bet"
		let PLAYERS_KEY = "players"
		let GLOBAL_BET_KEY = "makeBet"
		let CAMELS_KEY = "camels"
		// mutator
		let MAKE_ROLL_KEY = "roll"
		let MAKE_BET_KEY = "makeBet"

		// url
		let BASE_COMM_URL = window.location.origin + "/" + GAME_COMM_ROUTE + GAME_ID
		console.log(BASE_COMM_URL)
		let user_name = ""
		// helpers
		// return a promise, use then
		// will try to consume a json or text
		function fetch_url(url) {
			// console.log("fetching [" + url + "]")
			return fetch(url)
				.then(res => {
					let type = res.headers.get('content-type')
					if (type.includes("application/json")) {
						return res.json()
					} else if (type.includes("text")) {
						return res.text()
					} else {
						return res.data()
					}
				})
				.then(thing => {
					console.log("Response:")
					console.log(thing);
					return thing
				})
				.catch(err => console.log(err));
		}

		// request using a game action		
		function gameAction(action) {
			return fetch_url(BASE_COMM_URL + "?action=" + encodeURI(action));
		}

		// set uname send address
		function createPlayer(name) {
			if (event.key === "Enter" || event.keyCode === 12) {
				gameAction(NAME_KEY + "&" + NAME_KEY + "=" + name)
					.then(name => {
						console.log("new name is " + name)
						user_name = name;
						////// start of game!
						initGame();
					})
			}
		}

		// getters
		function getPlayer() {
			return gameAction(PLAYERS_KEY)
		}

		function getCamels() {
			return gameAction(CAMELS_KEY)
		}

		function getDice() {
			return gameAction(DICE_KEY)
		}

		// actions
		function makeRoll() {
			gameAction(MAKE_ROLL_KEY).then(li => {
				// update dice
				updateDice(li)
				// then get camels
				getCamels().then(cams => updateCamels(cams))
			})
		}

		COLOR_KEYS = ["RED", "GREEN", "BLUE", "BLACK", "WHITE", "PURPLE", "GOLD"]
		// game states
		const dice_el = document.querySelectorAll(".die-el")
		var camels_el = document.querySelectorAll('.camel-el')
		// initialize
		for (var i = 0; i < COLOR_KEYS.length; i++) {
			dice_el[i].style.backgroundColor = COLOR_KEYS[i];
		}
		for (var i = 0; i < COLOR_KEYS.length; i++) {
			camels_el[i].style.backgroundColor = COLOR_KEYS[i];
		}
		var players_list = []

		// helpers ------------------------

		var updateDice = (avaliables) => {
			// update
			for (var i = 0; i < COLOR_KEYS.length; i++) {
				if (avaliables.includes(COLOR_KEYS[i])) {
					dice_el[i].style.opacity = 1
				} else {
					dice_el[i].style.opacity = 0.1
				}
			}
		} 

		// color maps to location
		var updateCamels = (cam) => {
			for (var i = 0; i < COLOR_KEYS.length; i++) {
				var left = cam[COLOR_KEYS[i]][0] / 20 * 100
				camels_el[i].style.left = left + "%"
				var bottom = cam[COLOR_KEYS[i]][1] / 7 * 100
				camels_el[i].style.bottom = bottom + "%"
			}
		}


		// start of game

		function initGame() {
			// body...
			// fetch everything
			// dice
			getDice().then(li => updateDice(li));
			// camels
			getCamels().then(cam => updateCamels(cam));
		}

		

	</script>
</body>
</html>